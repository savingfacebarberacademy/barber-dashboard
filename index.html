<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Barber Dashboard - UPDATED VERSION</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #272727 0%, #EFEFEF 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .login-form { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .form-group { 
            margin: 20px 0; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        select, input, button { 
            padding: 10px 15px; 
            border: 2px solid #272727; 
            border-radius: 5px; 
            font-size: 16px;
            width: 200px;
        }
        button { 
            background: #FFC956; 
            cursor: pointer; 
            font-weight: bold;
            width: auto;
            padding: 10px 20px;
        }
        button:hover { 
            background: #272727; 
            color: white; 
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .error { 
            color: red; 
            margin: 10px 0; 
        }
        .status { 
            margin: 20px 0; 
            padding: 15px; 
            background: #f0f0f0; 
            border-radius: 5px; 
        }
        .dashboard { 
            display: none; 
        }
        .leaderboard {
            display: none;
        }
        .metric { 
            border: 2px solid #FFC956; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
        }
        .metric h3 { 
            margin: 0 0 10px 0; 
            color: #272727; 
        }
        .metric-value { 
            font-size: 2em; 
            font-weight: bold; 
            color: #272727; 
        }
        .admin-panel { 
            background: #f9f9f9; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 2px solid #FFC956; 
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #FFC956;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .leaderboard-item.you {
            background: #FFC956;
            font-weight: bold;
        }
        .leaderboard-item.top3 {
            background: linear-gradient(45deg, #FFC956, #FFF7EC);
            font-weight: bold;
        }
        .leaderboard-tabs {
            margin: 20px 0;
            text-align: center;
        }
        .leaderboard-tab {
            margin: 0 10px;
            padding: 10px 20px;
            background: #f0f0f0;
            border: 2px solid #272727;
            border-radius: 5px;
            cursor: pointer;
        }
        .leaderboard-tab.active {
            background: #FFC956;
            font-weight: bold;
        }
        .debug-btn {
            background: #ff6666 !important;
            color: white !important;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #272727;">SAVING FACE Barber Dashboard</h1>
        <h2 style="text-align: center; color: #666; font-size: 1em;">UPDATED VERSION - Check line count!</h2>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-form">
            <div class="status" id="loadStatus">Loading barber data...</div>
            
            <div class="form-group">
                <label>Select Your Name:</label>
                <select id="barberSelect">
                    <option>Loading...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="passwordInput" placeholder="Enter your password">
            </div>
            
            <button id="loginBtn" disabled>Login</button>
            
            <div class="error" id="errorMsg" style="display: none;"></div>
            
            <!-- Admin Section -->
            <div class="admin-panel">
                <h3>Admin Access</h3>
                <input type="password" id="adminPassword" placeholder="Admin password" style="margin-right: 10px;">
                <button id="adminBtn">Admin Login</button>
                <div id="adminPanel" style="display: none; margin-top: 20px;">
                    <p>CSV Status: <span id="csvStatus">Unknown</span></p>
                    <button id="testCsvBtn">Test CSV File</button>
                    <button id="reloadBtn">Reload Data</button>
                    <button id="debugBtn" class="debug-btn">üêõ DEBUG LEADERBOARD</button>
                    <button id="forceLeaderboard" class="debug-btn">üöÄ FORCE LEADERBOARD TEST</button>
                    <div id="debugOutput" style="margin-top: 15px; padding: 10px; background: #eee; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;"></div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard">
            <div style="text-align: right; margin-bottom: 20px;">
                <button id="leaderboardBtn" style="margin-right: 10px; background: #FFC956; border: 2px solid #272727;">üèÜ Leaderboard</button>
                <button id="logoutBtn">Logout</button>
            </div>
            
            <h2 id="barberName">Barber Name</h2>
            <p>Current Tier: <span id="currentTier">1</span> | Location: <span id="location">Unknown</span></p>
            
            <div class="metric">
                <h3>Services Per Month</h3>
                <div class="metric-value" id="servicesValue">0</div>
                <p id="servicesTarget">Target for next tier</p>
            </div>
            
            <div class="metric">
                <h3>Products Sold Per Month</h3>
                <div class="metric-value" id="productsValue">0</div>
                <p id="productsTarget">Target for next tier</p>
            </div>
            
            <div class="metric">
                <h3>Client Retention</h3>
                <div class="metric-value" id="retentionValue">0%</div>
                <p id="retentionTarget">Target for next tier</p>
            </div>
            
            <div class="metric">
                <h3>Tier Progress & Qualified Months</h3>
                <p id="tierProgress">Progress toward next tier</p>
                <div id="qualifiedMonths" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    <strong>Qualified Months Progress:</strong>
                    <div id="monthsBreakdown">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Leaderboard Section -->
        <div id="leaderboardSection" class="leaderboard">
            <div style="text-align: right; margin-bottom: 20px;">
                <button id="backToDashboard">Back to Dashboard</button>
                <button id="logoutBtn2">Logout</button>
            </div>
            
            <h2>üèÜ Company Leaderboard</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Anonymous rankings ‚Ä¢ Your position is highlighted</p>
            
            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" data-metric="services">Services</button>
                <button class="leaderboard-tab" data-metric="products">Products</button>
                <button class="leaderboard-tab" data-metric="retention">Retention</button>
                <button class="leaderboard-tab" data-metric="overall">Overall Score</button>
            </div>
            
            <div id="yourPosition" style="text-align: center; background: #FFC956; padding: 15px; border-radius: 8px; margin: 20px 0; font-weight: bold;"></div>
            
            <div id="leaderboardList">
                <p>Loading leaderboard...</p>
            </div>
        </div>
    </div>

    <script>
        var barberData = [];
        var currentBarber = null;
        var isAdmin = false;

        // Load CSV data when page loads
        loadCSVData();

        function loadCSVData() {
            document.getElementById('loadStatus').textContent = 'Loading CSV file...';
            
            fetch('./barber-data.csv?t=' + Date.now())
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.text();
                })
                .then(function(csvText) {
                    document.getElementById('loadStatus').textContent = 'Parsing data...';
                    parseCSV(csvText);
                    document.getElementById('loadStatus').textContent = 'Data loaded successfully! (' + barberData.length + ' records)';
                    populateBarberSelect();
                })
                .catch(function(error) {
                    document.getElementById('loadStatus').textContent = 'Error loading data: ' + error.message;
                    console.error('Error:', error);
                });
        }

        function parseCSV(csvText) {
            var lines = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            var headers = lines[0].split(',').map(function(h) { return h.trim().toLowerCase(); });
            
            barberData = [];
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                var values = line.split(',').map(function(v) { return v.trim(); });
                if (values.length < headers.length) continue;
                
                var row = {};
                for (var j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] || '';
                }
                
                row.services = parseInt(row.services) || 0;
                row.products = parseInt(row.products) || 0;
                row.retention = parseFloat(row.retention) || 0;
                row.startingtier = parseInt(row.startingtier) || 1;
                
                barberData.push(row);
            }
        }

        function populateBarberSelect() {
            var select = document.getElementById('barberSelect');
            var uniqueBarbers = [];
            
            for (var i = 0; i < barberData.length; i++) {
                if (uniqueBarbers.indexOf(barberData[i].name) === -1) {
                    uniqueBarbers.push(barberData[i].name);
                }
            }
            
            select.innerHTML = '<option value="">Select your name...</option>';
            for (var i = 0; i < uniqueBarbers.length; i++) {
                var option = document.createElement('option');
                option.value = uniqueBarbers[i];
                option.textContent = uniqueBarbers[i];
                select.appendChild(option);
            }
            
            enableLoginForm();
        }

        function enableLoginForm() {
            var select = document.getElementById('barberSelect');
            var password = document.getElementById('passwordInput');
            var loginBtn = document.getElementById('loginBtn');
            
            function checkForm() {
                loginBtn.disabled = !(select.value && password.value.trim());
            }
            
            select.addEventListener('change', checkForm);
            password.addEventListener('input', checkForm);
            loginBtn.addEventListener('click', handleLogin);
            
            // Event listeners for all buttons
            document.getElementById('adminBtn').addEventListener('click', handleAdminLogin);
            document.getElementById('testCsvBtn').addEventListener('click', testCSV);
            document.getElementById('reloadBtn').addEventListener('click', loadCSVData);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('logoutBtn2').addEventListener('click', logout);
            document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);
            document.getElementById('backToDashboard').addEventListener('click', backToDashboard);
            document.getElementById('debugBtn').addEventListener('click', runDebugReport);
            document.getElementById('forceLeaderboard').addEventListener('click', forceLeaderboardTest);
            
            // Leaderboard tabs
            var tabs = document.querySelectorAll('.leaderboard-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].addEventListener('click', function() {
                    var allTabs = document.querySelectorAll('.leaderboard-tab');
                    for (var j = 0; j < allTabs.length; j++) {
                        allTabs[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    updateLeaderboard(this.getAttribute('data-metric'));
                });
            }
        }

        function handleLogin() {
            var selectedName = document.getElementById('barberSelect').value;
            var enteredPassword = document.getElementById('passwordInput').value.trim();
            
            var barberRows = barberData.filter(function(row) {
                return row.name === selectedName;
            });
            
            if (barberRows.length === 0) {
                showError('No data found for this barber');
                return;
            }
            
            if (enteredPassword !== barberRows[0].password) {
                showError('Incorrect password');
                return;
            }
            
            currentBarber = selectedName;
            showDashboard();
            displayBarberData(selectedName);
            hideError();
        }

        function handleAdminLogin() {
            var adminPassword = document.getElementById('adminPassword').value;
            if (adminPassword === 'admin2024') {
                isAdmin = true;
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('csvStatus').textContent = 'Admin access granted - ' + barberData.length + ' records loaded';
                hideError();
            } else {
                showError('Incorrect admin password');
            }
        }

        function testCSV() {
            var debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.textContent = 'Testing CSV access...\n';
            
            fetch('./barber-data.csv?test=' + Date.now())
                .then(function(response) {
                    debugOutput.textContent += 'Response status: ' + response.status + '\n';
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('HTTP ' + response.status);
                })
                .then(function(text) {
                    debugOutput.textContent += 'Success! File size: ' + text.length + ' characters\n';
                    debugOutput.textContent += 'First 100 chars: ' + text.substring(0, 100) + '...\n';
                })
                .catch(function(error) {
                    debugOutput.textContent += 'Error: ' + error.message + '\n';
                });
        }

        function runDebugReport() {
            var debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            
            var report = 'LEADERBOARD DEBUG REPORT:\n';
            report += '========================\n';
            report += '1. barberData.length: ' + barberData.length + '\n';
            
            if (barberData.length > 0) {
                report += '2. Sample row: ' + JSON.stringify(barberData[0]) + '\n';
                
                var uniqueBarbers = getUniqueBarbers();
                report += '3. Unique barbers: ' + uniqueBarbers.length + ' found\n';
                report += '   Names: ' + uniqueBarbers.join(', ') + '\n';
                
                try {
                    var stats = calculateBarberStats();
                    var statKeys = Object.keys(stats);
                    report += '4. Stats calculated: ' + statKeys.length + ' barbers\n';
                    
                    if (statKeys.length > 0) {
                        report += '5. Sample stats: ' + JSON.stringify(stats[statKeys[0]]) + '\n';
                    } else {
                        report += '5. ERROR: No stats calculated!\n';
                    }
                } catch (error) {
                    report += '4. ERROR in calculateBarberStats: ' + error.message + '\n';
                    report += '   Stack: ' + error.stack + '\n';
                }
            } else {
                report += '2. ERROR: No barber data loaded!\n';
            }
            
            debugOutput.textContent = report;
        }

        function forceLeaderboardTest() {
            var debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.textContent = 'FORCING LEADERBOARD UPDATE...\n';
            
            try {
                updateLeaderboard('overall');
                debugOutput.textContent += 'Leaderboard update completed successfully!\n';
            } catch (error) {
                debugOutput.textContent += 'ERROR in updateLeaderboard: ' + error.message + '\n';
                debugOutput.textContent += 'Stack: ' + error.stack + '\n';
            }
        }

        function getUniqueBarbers() {
            var uniqueBarbers = [];
            for (var i = 0; i < barberData.length; i++) {
                if (uniqueBarbers.indexOf(barberData[i].name) === -1) {
                    uniqueBarbers.push(barberData[i].name);
                }
            }
            return uniqueBarbers;
        }

        function displayBarberData(barberName) {
            var barberRows = barberData.filter(function(row) {
                return row.name === barberName;
            });
            
            if (barberRows.length === 0) return;
            
            // Calculate averages (using all available data for now)
            var totalServices = 0, totalProducts = 0, totalRetention = 0;
            for (var i = 0; i < barberRows.length; i++) {
                totalServices += barberRows[i].services;
                totalProducts += barberRows[i].products;
                totalRetention += barberRows[i].retention;
            }
            
            var avgServices = totalServices / barberRows.length;
            var avgProducts = totalProducts / barberRows.length;
            var avgRetention = totalRetention / barberRows.length;
            
            // Determine current tier and calculate qualified months
            var startingTier = barberRows[0].startingtier || 1;
            var currentTier = startingTier;
            
            // Count qualified months for each tier
            var tier2QualifiedMonths = 0;
            var tier3QualifiedMonths = 0;
            
            for (var i = 0; i < barberRows.length; i++) {
                var row = barberRows[i];
                if (row.services >= 200 && row.products >= 7 && row.retention >= 70) {
                    tier2QualifiedMonths++;
                }
                if (row.services >= 225 && row.products >= 10 && row.retention >= 80) {
                    tier3QualifiedMonths++;
                }
            }
            
            // Determine actual current tier
            if (startingTier < 3 && tier3QualifiedMonths >= 7) {
                currentTier = 3;
            } else if (startingTier < 2 && tier2QualifiedMonths >= 7) {
                currentTier = 2;
            }
            
            // Update display
            document.getElementById('barberName').textContent = barberName;
            document.getElementById('currentTier').textContent = currentTier;
            document.getElementById('location').textContent = barberRows[0].location || 'Unknown';
            
            document.getElementById('servicesValue').textContent = Math.round(avgServices);
            document.getElementById('productsValue').textContent = avgProducts.toFixed(1);
            document.getElementById('retentionValue').textContent = Math.round(avgRetention) + '%';
            
            // Set targets based on current tier
            if (currentTier === 1) {
                document.getElementById('servicesTarget').textContent = 'Need 200 for Tier 2';
                document.getElementById('productsTarget').textContent = 'Need 7 for Tier 2';
                document.getElementById('retentionTarget').textContent = 'Need 70% for Tier 2';
            } else if (currentTier === 2) {
                document.getElementById('servicesTarget').textContent = 'Need 225 for Tier 3';
                document.getElementById('productsTarget').textContent = 'Need 10 for Tier 3';
                document.getElementById('retentionTarget').textContent = 'Need 80% for Tier 3';
            } else {
                document.getElementById('servicesTarget').textContent = 'Maximum tier achieved!';
                document.getElementById('productsTarget').textContent = 'Maximum tier achieved!';
                document.getElementById('retentionTarget').textContent = 'Maximum tier achieved!';
            }
            
            document.getElementById('tierProgress').textContent = 'Currently Tier ' + currentTier + ' - Keep up the great work!';
            
            // Show qualified months progress
            updateQualifiedMonthsDisplay(currentTier, tier2QualifiedMonths, tier3QualifiedMonths, barberRows.length);
        }

        function updateQualifiedMonthsDisplay(currentTier, tier2Months, tier3Months, totalMonths) {
            var breakdown = document.getElementById('monthsBreakdown');
            var html = '';
            
            if (currentTier === 1) {
                var monthsNeeded = Math.max(0, 7 - tier2Months);
                html += '<div>üìä Tier 2 Progress: ' + tier2Months + '/7 qualified months</div>';
                if (monthsNeeded > 0) {
                    html += '<div style="color: #666;">Need ' + monthsNeeded + ' more qualifying months for Tier 2</div>';
                } else {
                    html += '<div style="color: green;">‚úÖ Ready for Tier 2 promotion!</div>';
                }
                html += '<div style="font-size: 0.9em; margin-top: 5px;">Qualifying month: 200+ services, 7+ products, 70%+ retention</div>';
                
            } else if (currentTier === 2) {
                var monthsNeeded = Math.max(0, 7 - tier3Months);
                html += '<div>üìä Tier 3 Progress: ' + tier3Months + '/7 qualified months</div>';
                if (monthsNeeded > 0) {
                    html += '<div style="color: #666;">Need ' + monthsNeeded + ' more qualifying months for Tier 3</div>';
                } else {
                    html += '<div style="color: green;">‚úÖ Ready for Tier 3 promotion!</div>';
                }
                html += '<div style="font-size: 0.9em; margin-top: 5px;">Qualifying month: 225+ services, 10+ products, 80%+ retention</div>';
                
            } else {
                html += '<div style="color: green;">üèÜ Maximum Tier Achieved!</div>';
                html += '<div>Tier 3 qualified months: ' + tier3Months + '/7 ‚úÖ</div>';
            }
            
            html += '<div style="margin-top: 10px; font-size: 0.9em; color: #666;">Total months of data: ' + totalMonths + '</div>';
            
            breakdown.innerHTML = html;
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('leaderboardSection').style.display = 'none';
        }
        
        function showLeaderboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('leaderboardSection').style.display = 'block';
            updateLeaderboard('overall');
        }
        
        function backToDashboard() {
            document.getElementById('leaderboardSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
        }

        function logout() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('leaderboardSection').style.display = 'none';
            document.getElementById('barberSelect').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginBtn').disabled = true;
            currentBarber = null;
            isAdmin = false;
            hideError();
        }

        function showError(message) {
            var errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }
        
        function updateLeaderboard(metric) {
            var listContainer = document.getElementById('leaderboardList');
            
            try {
                var stats = calculateBarberStats();
                var barberNames = Object.keys(stats);
                
                if (barberNames.length === 0) {
                    listContainer.innerHTML = '<p style="color: red;">No barber stats calculated! Check debug report.</p>';
                    return;
                }
                
                // Sort by metric
                barberNames.sort(function(a, b) {
                    return stats[b][metric] - stats[a][metric];
                });
                
                // Show your position
                var yourPosition = document.getElementById('yourPosition');
                if (currentBarber) {
                    var yourRank = barberNames.indexOf(currentBarber) + 1;
                    yourPosition.textContent = 'üéØ Your Position: #' + yourRank + ' of ' + barberNames.length + ' barbers';
                    yourPosition.style.display = 'block';
                } else {
                    yourPosition.style.display = 'none';
                }
                
                // Create leaderboard list
                listContainer.innerHTML = '';
                
                for (var i = 0; i < barberNames.length; i++) {
                    var barber = barberNames[i];
                    var stat = stats[barber];
                    var isYou = barber === currentBarber;
                    var isTop3 = i < 3;
                    
                    var displayValue;
                    switch(metric) {
                        case 'services':
                            displayValue = Math.round(stat.services) + ' services/month';
                            break;
                        case 'products':
                            displayValue = stat.products.toFixed(1) + ' products/month';
                            break;
                        case 'retention':
                            displayValue = Math.round(stat.retention) + '% retention';
                            break;
                        case 'overall':
                            displayValue = 'Score: ' + Math.round(stat.overall);
                            break;
                    }
                    
                    var anonymousName = isYou ? 'You' : 'Barber ' + (i + 1);
                    var rankEmoji = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    
                    var itemDiv = document.createElement('div');
                    itemDiv.className = 'leaderboard-item' + (isYou ? ' you' : '') + (isTop3 && !isYou ? ' top3' : '');
                    
                    itemDiv.innerHTML = 
                        '<div><strong>' + rankEmoji + ' #' + (i + 1) + ' ' + anonymousName + '</strong></div>' +
                        '<div>' + displayValue + ' | Tier ' + stat.tier + '</div>';
                    
                    listContainer.appendChild(itemDiv);
                }
            } catch (error) {
                listContainer.innerHTML = '<p style="color: red;">Error creating leaderboard: ' + error.message + '</p>';
            }
        }
        
        function calculateBarberStats() {
            var stats = {};
            var uniqueBarbers = getUniqueBarbers();
            
            for (var i = 0; i < uniqueBarbers.length; i++) {
                var barber = uniqueBarbers[i];
                var barberRows = barberData.filter(function(row) {
                    return row.name === barber;
                });
                
                if (barberRows.length === 0) continue;
                
                var totalServices = 0, totalProducts = 0, totalRetention = 0;
                for (var j = 0; j < barberRows.length; j++) {
                    totalServices += barberRows[j].services;
                    totalProducts += barberRows[j].products;
                    totalRetention += barberRows[j].retention;
                }
                
                var avgServices = totalServices / barberRows.length;
                var avgProducts = totalProducts / barberRows.length;
                var avgRetention = totalRetention / barberRows.length;
                
                // Determine current tier
                var startingTier = barberRows[0].startingtier || 1;
                var currentTier = startingTier;
                
                // Count qualified months for tier advancement
                var tier2QualifiedMonths = 0;
                var tier3QualifiedMonths = 0;
                
                for (var j = 0; j < barberRows.length; j++) {
                    var row = barberRows[j];
                    if (row.services >= 200 && row.products >= 7 && row.retention >= 70) {
                        tier2QualifiedMonths++;
                    }
                    if (row.services >= 225 && row.products >= 10 && row.retention >= 80) {
                        tier3QualifiedMonths++;
                    }
                }
                
                // Determine actual tier based on qualified months
                if (startingTier < 3 && tier3QualifiedMonths >= 7) {
                    currentTier = 3;
                } else if (startingTier < 2 && tier2QualifiedMonths >= 7) {
                    currentTier = 2;
                }
                
                // Calculate overall score (weighted combination)
                var overallScore = (avgServices * 0.4) + (avgProducts * 8) + (avgRetention * 0.6) + (currentTier * 50);
                
                stats[barber] = {
                    services: avgServices,
                    products: avgProducts,
                    retention: avgRetention,
                    tier: currentTier,
                    overall: overallScore
                };
            }
            
            return stats;
        }
    </script>
</body>
</html>
